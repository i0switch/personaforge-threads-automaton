
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

// Direct configuration (recommended for Lovable)
const supabaseConfig = {
  url: 'https://tqcgbsnoiarnawnppwia.supabase.co',
  anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxY2dic25vaWFybmF3bnBwd2lhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5MTUxODEsImV4cCI6MjA2NTQ5MTE4MX0.5_mXobtncEbIHyigC_EqP-z1cr7AWYepR7L2CZwjBvI'
};

// iOS Safariå¯¾å¿œã®å®‰å…¨ãªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼
const createSafeStorage = () => {
  // iOS Safariç‰¹æœ‰ã®å•é¡Œã‚’æ¤œå‡º
  const isIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) && 
                     /WebKit/.test(navigator.userAgent) && 
                     !/CriOS|FxiOS|OPiOS|mercury/.test(navigator.userAgent);
  
  try {
    // ã‚ˆã‚Šå®‰å…¨ãªlocalStorageãƒ†ã‚¹ãƒˆ
    if (typeof window === 'undefined' || !window.localStorage) {
      throw new Error('localStorage not available');
    }
    
    const testKey = '__supabase_test__';
    window.localStorage.setItem(testKey, '1');
    const testValue = window.localStorage.getItem(testKey);
    window.localStorage.removeItem(testKey);
    
    if (testValue !== '1') {
      throw new Error('localStorage test failed');
    }
    
    // iOS Safariã®å ´åˆã€è¿½åŠ ãƒã‚§ãƒƒã‚¯
    if (isIOSSafari) {
      // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã¯ quota exceeded ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
      try {
        const testData = 'x'.repeat(1024); // 1KB ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
        window.localStorage.setItem('__ios_quota_test__', testData);
        window.localStorage.removeItem('__ios_quota_test__');
      } catch (quotaError) {
        console.warn('iOS Safari ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ ã¾ãŸã¯ quotaåˆ¶é™æ¤œå‡ºã€ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨');
        throw new Error('iOS Storage quota exceeded');
      }
    }
    
    return window.localStorage;
  } catch (error) {
    console.warn('localStorageä½¿ç”¨ä¸å¯ã€ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨:', error);
    const memoryStore = new Map<string, string>();
    
    // ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®Ÿè£…ã‚’æ”¹å–„
    const memoryStorage = {
      getItem: (key: string) => {
        try {
          return memoryStore.get(key) ?? null;
        } catch {
          return null;
        }
      },
      setItem: (key: string, value: string) => {
        try {
          memoryStore.set(key, value);
        } catch (e) {
          console.warn('Memory storage setItem failed:', e);
        }
      },
      removeItem: (key: string) => {
        try {
          memoryStore.delete(key);
        } catch (e) {
          console.warn('Memory storage removeItem failed:', e);
        }
      },
      clear: () => {
        try {
          memoryStore.clear();
        } catch (e) {
          console.warn('Memory storage clear failed:', e);
        }
      },
      key: (_index: number) => null,
      length: memoryStore.size,
    } as unknown as Storage;
    
    return memoryStorage;
  }
};

const safeStorage = createSafeStorage();

// ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼
const validateToken = (token: string): boolean => {
  try {
    const parts = token.split('.');
    if (parts.length !== 3) return false;
    
    const payload = JSON.parse(atob(parts[1]));
    
    // subã‚¯ãƒ¬ãƒ¼ãƒ ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼‰ãŒå¿…é ˆ
    if (!payload.sub) {
      console.error('Invalid token: missing sub claim');
      return false;
    }
    
    // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
    if (payload.exp && payload.exp * 1000 < Date.now()) {
      console.error('Invalid token: expired');
      return false;
    }
    
    return true;
  } catch (error) {
    console.error('Token validation error:', error);
    return false;
  }
};

// Configure Supabase client with proper auth settings
export const supabase = createClient<Database>(
  supabaseConfig.url,
  supabaseConfig.anonKey,
  {
    auth: {
      storage: safeStorage,
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true
    }
  }
  );

  // Fully disable Supabase Realtime globally to comply with strict CSP (no WebSockets allowed)
  try {
    const noop = () => {};
    const stubChannel = () => {
      const stub: any = {
        on: () => stub,
        subscribe: () => stub,
        unsubscribe: () => {},
      };
      return stub;
    };
    // Override realtime interfaces to avoid any WebSocket usage
    // @ts-ignore
    (supabase as any).channel = stubChannel;
    // @ts-ignore
    (supabase as any).removeChannel = noop;
    // @ts-ignore
    (supabase as any).realtime = {
      channel: stubChannel,
      setAuth: noop,
      connect: noop,
      remove: noop,
      removeChannel: noop,
    };
    console.warn('Supabase Realtime globally disabled to avoid CSP/WebSocket issues.');
  } catch {}

  // åˆæœŸã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼ã¨è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  (async () => {
    try {
      console.log('ğŸ” Checking session validity on startup...');
      const { data: { session } } = await supabase.auth.getSession();
      
      if (session?.access_token) {
        const isValid = validateToken(session.access_token);
        
        if (!isValid) {
          console.warn('âš ï¸ Invalid session detected on startup, clearing...');
          await supabase.auth.signOut({ scope: 'local' });
          localStorage.clear();
          sessionStorage.clear();
          console.log('ğŸ§¹ Cleared invalid session');
        } else {
          console.log('âœ… Valid session confirmed on startup');
        }
      } else {
        console.log('â„¹ï¸ No session found on startup');
      }
    } catch (error) {
      console.error('âŒ Session validation on startup failed:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚å¿µã®ãŸã‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      try {
        await supabase.auth.signOut({ scope: 'local' });
        localStorage.clear();
        sessionStorage.clear();
      } catch (cleanupError) {
        console.error('Cleanup error:', cleanupError);
      }
    }
  })();

  // Log configuration status (development only)
  if (import.meta.env.DEV) {
  console.log('Supabase client configured successfully');
  console.log('Project URL:', supabaseConfig.url);
  console.log('Auth storage:', safeStorage === window.localStorage ? 'localStorage' : 'in-memory');
}
