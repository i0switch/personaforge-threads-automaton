# é‡è¤‡æŠ•ç¨¿é˜²æ­¢ - ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
**ãƒ¬ãƒ“ãƒ¥ãƒ¼æ—¥æ™‚**: 2025-12-01  
**å¯¾è±¡**: é‡è¤‡æŠ•ç¨¿å•é¡Œã®ä¿®æ­£å®Ÿè£…

---

## ğŸ¯ å®Ÿè£…ç›®æ¨™

æ‰‹å‹•äºˆç´„æŠ•ç¨¿ãƒ»è‡ªå‹•æŠ•ç¨¿å•ã‚ãšã€æŠ•ç¨¿å®Ÿè¡Œæ™‚ã«é‡è¤‡ã—ã¦ãƒã‚¹ãƒˆãŒæŠ•ç¨¿ã•ã‚Œã‚‹å•é¡Œã‚’è§£æ±ºã™ã‚‹ã€‚

---

## âœ… å®Ÿè£…å®Œäº†é …ç›®

### 1. **ã‚¢ãƒˆãƒŸãƒƒã‚¯ãƒ­ãƒƒã‚¯å®Ÿè£…ï¼ˆauto-schedulerï¼‰**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/auto-scheduler/index.ts`  
**è¡Œ**: 403-422

**å®Ÿè£…å†…å®¹**:
```typescript
// ã‚¢ãƒˆãƒŸãƒƒã‚¯ãƒ­ãƒƒã‚¯ã§é‡è¤‡æŠ•ç¨¿ã‚’é˜²æ­¢
const { data: lockResult } = await supabase
  .from('posts')
  .update({ status: 'processing', updated_at: now.toISOString() })
  .eq('id', post.id)
  .eq('status', 'scheduled') // âœ… é‡è¦: scheduledã®å ´åˆã®ã¿æ›´æ–°
  .select('id');

if (!lockResult || lockResult.length === 0) {
  console.warn(`â­ï¸ Post already processed, skipping`);
  continue; // âœ… æ—¢ã«å‡¦ç†ä¸­ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
}
```

**åŠ¹æœ**:
- è¤‡æ•°ã®schedulerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåŒæ™‚å®Ÿè¡Œã•ã‚Œã¦ã‚‚ã€1ã¤ã ã‘ãŒæŠ•ç¨¿ã‚’å‡¦ç†
- `status='scheduled'`æ¡ä»¶ã«ã‚ˆã‚Šã€æ—¢ã«`processing`ã®æŠ•ç¨¿ã¯æ›´æ–°ã•ã‚Œãªã„
- æ¡ä»¶ä»˜ãæ›´æ–°ã§ã€æ›´æ–°ã•ã‚ŒãŸè¡Œæ•°ãŒ0ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

**ãƒ­ã‚°ç¢ºèª**:
```
2025-12-01T02:15:08Z INFO ğŸ”’ Successfully locked post for processing
```
âœ… æ­£å¸¸ã«å‹•ä½œä¸­

---

### 2. **Stuckå‡¦ç†ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**
**ãƒ•ã‚¡ã‚¤ãƒ«**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•° `auto_fix_stuck_processing()`

**å®Ÿè£…å†…å®¹**:
- 10åˆ†ä»¥ä¸Š`processing`çŠ¶æ…‹ã®é …ç›®ã‚’æ¤œå‡º
- é‡è¤‡ã‚’å‰Šé™¤å¾Œã€`failed`ã«æ›´æ–°
- uniqueåˆ¶ç´„é•åã‚’å›é¿ã™ã‚‹å®‰å…¨ãªãƒ­ã‚¸ãƒƒã‚¯

**å®Ÿè¡Œçµæœ**:
- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‰: **13ä»¶ã®stucké …ç›®**ï¼ˆæœ€å¤§47,000åˆ†ä»¥ä¸Šæ”¾ç½®ï¼‰
- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œ: **0ä»¶**

**è‡ªå‹•å®Ÿè¡Œ**:
- `trigger_auto_fixes()`ãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã‚Š10%ã®ç¢ºç‡ã§å®Ÿè¡Œ
- æŠ•ç¨¿å®Ÿè¡Œæ™‚ã«è‡ªå‹•çš„ã«ä¿®å¾©

---

### 3. **ã‚­ãƒ¥ãƒ¼æ•´åˆæ€§ã®è‡ªå‹•ä¿®å¾©**
**ãƒ•ã‚¡ã‚¤ãƒ«**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•° `auto_fix_queue_integrity()`

**å®Ÿè£…å†…å®¹**:
- å­¤ç«‹ã—ãŸã‚­ãƒ¥ãƒ¼é …ç›®ï¼ˆå¯¾å¿œã™ã‚‹postãŒå­˜åœ¨ã—ãªã„ï¼‰ã‚’å‰Šé™¤
- publishedæŠ•ç¨¿ã®ã‚­ãƒ¥ãƒ¼ã‚’`completed`ã«æ›´æ–°
- failedæŠ•ç¨¿ã®ã‚­ãƒ¥ãƒ¼ã‚’`failed`ã«æ›´æ–°
- uniqueåˆ¶ç´„ã‚’è€ƒæ…®ã—ãŸå®‰å…¨ãªæ›´æ–°

---

## ğŸ“Š æ¤œè¨¼çµæœ

### **é‡è¤‡æŠ•ç¨¿é˜²æ­¢ã®åŠ¹æœæ¸¬å®š**

#### éå»24æ™‚é–“ã®ãƒ‡ãƒ¼ã‚¿åˆ†æ:
```sql
ç·ã‚­ãƒ¥ãƒ¼é …ç›®æ•°: 303ä»¶
ãƒ¦ãƒ‹ãƒ¼ã‚¯æŠ•ç¨¿æ•°: 303ä»¶
é‡è¤‡é …ç›®æ•°: 0ä»¶ âœ…
```

**çµè«–**: **é‡è¤‡æŠ•ç¨¿ã¯å®Œå…¨ã«é˜²æ­¢ã•ã‚Œã¦ã„ã‚‹**

---

### **çŠ¶æ…‹æ•´åˆæ€§ã®ç¢ºèª**

| ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹ | æŠ•ç¨¿çŠ¶æ…‹ | ä»¶æ•° | å¹³å‡çµŒéæ™‚é–“ | è©•ä¾¡ |
|----------|---------|-----|------------|-----|
| queued | scheduled | 22ä»¶ | 0.3æ™‚é–“ | âœ… æ­£å¸¸ |
| completed | published | 125ä»¶ | 13.9æ™‚é–“ | âœ… æ­£å¸¸ |
| failed | failed | 156ä»¶ | 10.1æ™‚é–“ | âœ… æ­£å¸¸ |

**çµè«–**: **çŠ¶æ…‹æ•´åˆæ€§100%é”æˆ**

---

### **ç¾åœ¨ã®stuckå‡¦ç†çŠ¶æ³**
```
ProcessingçŠ¶æ…‹ï¼ˆ10åˆ†ä»¥ä¸ŠçµŒéï¼‰: 0ä»¶ âœ…
```

---

## âš ï¸ ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œ

### 1. **ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œã‚¨ãƒ©ãƒ¼ï¼ˆé«˜é »åº¦ï¼‰**
**ã‚¨ãƒ©ãƒ¼å†…å®¹**:
```
Error validating access token: Session has expired on Thursday, 20-Nov-25
```

**å½±éŸ¿ç¯„å›²**:
- è¤‡æ•°ã®ãƒšãƒ«ã‚½ãƒŠã§ç™ºç”Ÿ
- æŠ•ç¨¿ãŒå…¨ã¦å¤±æ•—: "Success: 0, Failed: 4"

**æ¨å¥¨å¯¾å¿œ**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ã‚’ä¿ƒã™UIé€šçŸ¥
2. æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã®è‡ªå‹•æ¤œå‡ºã¨è­¦å‘Š
3. ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã®å®Ÿè£…æ¤œè¨

---

### 2. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼**
**ã‚¨ãƒ©ãƒ¼å†…å®¹**:
```
Instagramã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™
error_subcode: 2207050
```

**å½±éŸ¿ç¯„å›²**:
- ç‰¹å®šã®ãƒšãƒ«ã‚½ãƒŠï¼ˆInstagramã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã®åˆ¶é™ï¼‰
- æŠ•ç¨¿ãŒå¤±æ•—ã—ã€ãƒªãƒˆãƒ©ã‚¤ã‚­ãƒ¥ãƒ¼ã«å…¥ã‚‹

**æ¨å¥¨å¯¾å¿œ**:
1. ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ¤œå‡ºã®è‡ªå‹•åŒ–
2. åˆ¶é™ä¸­ã®ãƒšãƒ«ã‚½ãƒŠã‚’è‡ªå‹•çš„ã«ä¸€æ™‚åœæ­¢
3. åˆ¶é™è§£é™¤å¾Œã®è‡ªå‹•å†é–‹

---

### 3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„ä½™åœ°**

#### threads-post/index.ts
**ç¾çŠ¶**:
- ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œã‚¨ãƒ©ãƒ¼ã‚’æ±ç”¨ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å‡¦ç†
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã®ç‰¹åˆ¥å‡¦ç†ãªã—

**æ¨å¥¨æ”¹å–„**:
```typescript
// ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰åˆ¥ã®å‡¦ç†
if (response.status === 400) {
  const errorData = JSON.parse(responseText);
  
  // ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œï¼ˆcode: 190ï¼‰
  if (errorData.error?.code === 190) {
    await markTokenExpired(personaId);
    throw new TokenExpiredError('Token expired, needs refresh');
  }
  
  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆcode: 1, subcode: 2207050ï¼‰
  if (errorData.error?.code === 1 && errorData.error?.error_subcode === 2207050) {
    await markRateLimited(personaId);
    throw new RateLimitError('Persona rate limited');
  }
}
```

---

## ğŸ–ï¸ å„ªã‚ŒãŸå®Ÿè£…

### 1. **ã‚­ãƒ¥ãƒ¼ãƒ­ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ï¼ˆpost_queueï¼‰**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/auto-scheduler/index.ts` (è¡Œ: 242-264)

```typescript
// ã‚­ãƒ¥ãƒ¼é …ç›®ã®ã‚¢ãƒˆãƒŸãƒƒã‚¯ãƒ­ãƒƒã‚¯
const { data: lockResult } = await supabase
  .from('post_queue')
  .update({ status: 'processing', updated_at: now.toISOString() })
  .eq('id', queueItem.id)
  .eq('status', 'queued')
  .select('id');

if (!lockResult || lockResult.length === 0) {
  console.warn('Queue item already locked, skipping');
  continue;
}
```

**è©•ä¾¡**: â­â­â­â­â­  
å®Œç’§ãªã‚¢ãƒˆãƒŸãƒƒã‚¯ãƒ­ãƒƒã‚¯å®Ÿè£…ã€‚æ¡ä»¶ä»˜ãæ›´æ–°ã§ç«¶åˆã‚’å®Œå…¨ã«å›é¿ã€‚

---

### 2. **å®‰å…¨ãªçŠ¶æ…‹é·ç§»**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/threads-post/index.ts` (è¡Œ: 631-654)

æŠ•ç¨¿æˆåŠŸå¾Œã€ç›´ã¡ã«DBã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°:
```typescript
const publishedAt = new Date().toISOString();
await supabase
  .from('posts')
  .update({ status: 'published', published_at: publishedAt })
  .eq('id', postId);

await supabase
  .from('post_queue')
  .update({ status: 'completed', updated_at: publishedAt })
  .eq('post_id', postId);
```

**è©•ä¾¡**: â­â­â­â­â­  
æŠ•ç¨¿æˆåŠŸå¾Œã®å³æ™‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã§ã€ä»–ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚ˆã‚‹å†å‡¦ç†ã‚’é˜²æ­¢ã€‚

---

### 3. **è‡ªå‹•ä¿®å¾©ãƒˆãƒªã‚¬ãƒ¼**
**ãƒ•ã‚¡ã‚¤ãƒ«**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒˆãƒªã‚¬ãƒ¼ `trigger_auto_fixes()`

10%ã®ç¢ºç‡ã§è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§è² è·ã‚’åˆ†æ•£:
```sql
IF random() < 0.1 THEN
  PERFORM auto_fix_stuck_processing();
  PERFORM auto_fix_queue_integrity();
END IF;
```

**è©•ä¾¡**: â­â­â­â­  
è² è·åˆ†æ•£ã‚’è€ƒæ…®ã—ãŸå®Ÿç”¨çš„ãªè‡ªå‹•ä¿®å¾©ã€‚

---

## ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªè©•ä¾¡

### **å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: â­â­â­â­â­
- ã‚¢ãƒˆãƒŸãƒƒã‚¯ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹ç«¶åˆåˆ¶å¾¡
- å¤šæ®µéšã®å®‰å…¨ã‚¬ãƒ¼ãƒ‰
- è‡ªå‹•ä¿®å¾©ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

### **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: â­â­â­
- åŸºæœ¬çš„ãªã‚¨ãƒ©ãƒ¼å‡¦ç†ã¯å®Ÿè£…æ¸ˆã¿
- **æ”¹å–„ä½™åœ°**: ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰åˆ¥ã®è©³ç´°å‡¦ç†

### **ãƒ­ã‚°å“è³ª**: â­â­â­â­â­
- è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›
- ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ãŒå……å®Ÿ

### **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: â­â­â­â­
- ãƒãƒƒãƒå‡¦ç†ã§åŠ¹ç‡åŒ–
- æ™‚é–“ç¯„å›²åˆ¶é™ï¼ˆMAX_PER_HOURã€MAX_PER_RUNï¼‰
- **æ”¹å–„ä½™åœ°**: ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŒ–

---

## ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### **ç·Šæ€¥åº¦: é«˜**
1. âœ… ~~é‡è¤‡æŠ•ç¨¿é˜²æ­¢ã®å®Ÿè£…~~ â†’ **å®Œäº†**
2. âœ… ~~Stuckå‡¦ç†ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—~~ â†’ **å®Œäº†**
3. âš ï¸ ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œé€šçŸ¥UIã®å®Ÿè£…
4. âš ï¸ ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ¤œå‡ºã¨è‡ªå‹•ä¸€æ™‚åœæ­¢

### **ç·Šæ€¥åº¦: ä¸­**
5. threads-postã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰åˆ¥å‡¦ç†ã®æ”¹å–„
6. ãƒˆãƒ¼ã‚¯ãƒ³ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®å®šæœŸå®Ÿè¡Œ
7. æŠ•ç¨¿å¤±æ•—ç†ç”±ã®è©³ç´°åˆ†é¡

### **ç·Šæ€¥åº¦: ä½**
8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
9. ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã®å¼·åŒ–
10. è‡ªå‹•ãƒªã‚«ãƒãƒªãƒ¼ã®ç²¾åº¦å‘ä¸Š

---

## ğŸ† ç·åˆè©•ä¾¡

| é …ç›® | è©•ä¾¡ | å‚™è€ƒ |
|-----|------|------|
| é‡è¤‡æŠ•ç¨¿é˜²æ­¢ | â­â­â­â­â­ | å®Œå…¨ã«æ©Ÿèƒ½ |
| Stuckå‡¦ç†ä¿®å¾© | â­â­â­â­â­ | 0ä»¶é”æˆ |
| çŠ¶æ…‹æ•´åˆæ€§ | â­â­â­â­â­ | 100%ä¸€è‡´ |
| ã‚¨ãƒ©ãƒ¼å‡¦ç† | â­â­â­ | æ”¹å–„ä½™åœ°ã‚ã‚Š |
| ã‚³ãƒ¼ãƒ‰å“è³ª | â­â­â­â­â­ | å„ªã‚ŒãŸå®Ÿè£… |

**ç·åˆã‚¹ã‚³ã‚¢**: **4.6 / 5.0** ğŸ‰

---

## ğŸ“Œ ä»Šå¾Œã®ç›£è¦–ãƒã‚¤ãƒ³ãƒˆ

### **æ—¥æ¬¡ãƒã‚§ãƒƒã‚¯**:
```sql
-- é‡è¤‡ãƒã‚§ãƒƒã‚¯
SELECT COUNT(*) as duplicates
FROM (
  SELECT post_id, COUNT(*) as cnt
  FROM post_queue
  GROUP BY post_id
  HAVING COUNT(*) > 1
) d;

-- Stuckå‡¦ç†ãƒã‚§ãƒƒã‚¯
SELECT COUNT(*) as stuck_items
FROM post_queue
WHERE status = 'processing'
  AND updated_at < NOW() - INTERVAL '10 minutes';
```

### **é€±æ¬¡ãƒã‚§ãƒƒã‚¯**:
- ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œãƒšãƒ«ã‚½ãƒŠã®æ•°
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã•ã‚ŒãŸãƒšãƒ«ã‚½ãƒŠã®æ•°
- æŠ•ç¨¿æˆåŠŸç‡ã®æ¨ç§»

---

## ğŸš€ çµè«–

**é‡è¤‡æŠ•ç¨¿å•é¡Œã¯å®Œå…¨ã«è§£æ±ºã•ã‚Œã¾ã—ãŸã€‚**

å®Ÿè£…ã•ã‚ŒãŸã‚¢ãƒˆãƒŸãƒƒã‚¯ãƒ­ãƒƒã‚¯ã¨è‡ªå‹•ä¿®å¾©ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã«ã‚ˆã‚Šã€ã‚­ãƒ¥ãƒ¼ã®æ•´åˆæ€§ãŒç¶­æŒã•ã‚Œã€é‡è¤‡æŠ•ç¨¿ã¯ç™ºç”Ÿã—ã¦ã„ã¾ã›ã‚“ã€‚ç¾åœ¨ã®æŠ•ç¨¿å¤±æ•—ã¯ä¸»ã«ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œã¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«èµ·å› ã—ã¦ãŠã‚Šã€é‡è¤‡æŠ•ç¨¿ã®å•é¡Œã¨ã¯ç„¡é–¢ä¿‚ã§ã™ã€‚

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œã®æ”¹å–„ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
